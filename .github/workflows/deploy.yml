name: Build & Deploy Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install dependencies including Bootstrap
      - name: Install dependencies
        run: |
          npm install bootstrap
          npm install --save-dev sass terser html-minifier imagemin-cli imagemin-mozjpeg imagemin-pngquant imagemin-gifsicle sitemap-generator-cli

      # 4Ô∏è‚É£ Compile SCSS (compressed) with Bootstrap
      - name: Compile SCSS
        run: |
          if [ -d "src/scss" ]; then
            npx sass src/scss/styles.scss css/styles.css --style=compressed --load-path=node_modules
          else
            echo "No SCSS folder found, skipping SCSS compilation"
          fi

      # 5Ô∏è‚É£ Minify JS
      - name: Minify JS
        run: |
          for file in js/*.js; do
            npx terser "$file" -o "$file"
          done

      # 6Ô∏è‚É£ Minify HTML
      - name: Minify HTML
        run: |
          npx html-minifier --collapse-whitespace --remove-comments --minify-css true --minify-js true -o index.html index.html

      # 7Ô∏è‚É£ Optimize Images
      - name: Optimize images
        run: |
          mkdir -p public/assets/img
          npx imagemin assets/img/* --out-dir=public/assets/img || echo "No images to optimize"

      # 8Ô∏è‚É£ Prepare public folder
      - name: Copy site files
        run: |
          mkdir -p public
          cp index.html public/
          cp -r css js public/

      # üîü Generate sitemap
      - name: Generate sitemap
        run: |
          npx sitemap-generator-cli https://${{ secrets.CUSTOM_DOMAIN }}/ -o public/sitemap.xml || echo "Sitemap skipped"

      # 1Ô∏è‚É£1Ô∏è‚É£ Add CNAME
      - name: Add CNAME
        run: |
          if [ -n "${{ secrets.CUSTOM_DOMAIN }}" ]; then
            echo "${{ secrets.CUSTOM_DOMAIN }}" > public/CNAME
          else
            echo "No custom domain secret, skipping CNAME"
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Debug public folder
      - name: List public folder
        run: ls -R public/

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload artifact for deployment
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
