name: Build & Deploy Website

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: |
          npm install
          npm install --save-dev sass terser html-minifier imagemin-cli imagemin-mozjpeg imagemin-pngquant imagemin-gifsicle sitemap-generator-cli

      # 4️⃣ Compile SCSS (compressed)
      - name: Compile SCSS
        run: |
          if [ -d "src/scss" ]; then
            npx sass src/scss/styles.scss css/styles.css --style=compressed
          else
            echo "No SCSS folder found, skipping SCSS compilation"
          fi

      # 5️⃣ Minify JS
      - name: Minify JS
        run: |
          for file in js/*.js; do
            npx terser "$file" -o "$file"
          done

      # 6️⃣ Minify HTML
      - name: Minify HTML
        run: |
          npx html-minifier --collapse-whitespace --remove-comments --minify-css true --minify-js true -o index.html index.html

      # 7️⃣ Optimize images
      - name: Optimize images
        run: |
          mkdir -p public/assets/img
          npx imagemin assets/img/
