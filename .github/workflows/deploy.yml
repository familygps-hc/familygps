name: Build & Deploy Website

on:
  push:
    branches:
      - main  # Replace if your default branch is different
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install npm dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Compile SCSS (optional)
      - name: Compile SCSS
        run: |
          if [ -d "src/scss" ]; then
            npx sass src/scss/styles.scss css/styles.css --no-source-map
          else
            echo "No SCSS folder found, skipping SCSS compilation"
          fi

      # 5Ô∏è‚É£ Prepare public directory
      - name: Copy site files
        run: |
          mkdir -p public
          cp -r index.html css assets js public/

      # 6Ô∏è‚É£ Inject Google Analytics (optional, safe)
      - name: Inject Google Analytics
        run: |
          if [ -n "${{ secrets.GA_TRACKING_ID }}" ]; then
            GA_CODE="<script async src='https://www.googletagmanager.com/gtag/js?id=${{ secrets.GA_TRACKING_ID }}'></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '${{ secrets.GA_TRACKING_ID }}');
</script>"
            sed -i "/<\/head>/i ${GA_CODE}" public/index.html
          else
            echo "GA_TRACKING_ID secret not set, skipping GA injection"
          fi

      # 7Ô∏è‚É£ Generate sitemap (optional)
      - name: Generate sitemap
        run: |
          if command -v npx &> /dev/null; then
            npx sitemap-generator-cli https://YOUR_USERNAME.github.io/REPO_NAME/ -o public/sitemap.xml || echo "Sitemap skipped"
          else
            echo "sitemap-generator-cli not installed, skipping sitemap"
          fi

      # 8Ô∏è‚É£ Add CNAME for custom domain (optional)
      - name: Add CNAME
        run: |
          if [ -n "${{ secrets.CUSTOM_DOMAIN }}" ]; then
            echo "${{ secrets.CUSTOM_DOMAIN }}" > public/CNAME
          else
            echo "CUSTOM_DOMAIN secret not set, skipping CNAME"
          fi

      # 9Ô∏è‚É£ Debug: List public folder contents
      - name: List public folder
        run: ls -R public/

      # üîü Upload artifact for deployment
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
